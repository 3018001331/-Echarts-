<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<style type="text/css">
			body,
			html,
			#allmap {
				width: 100%;
				height: 100%;
				overflow: hidden;
				margin: 0;
				font-family: "微软雅黑";
			}
		</style>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=eYf9sA6yVTFHlh9ytU4a0EYY"></script>
		<title>规划驾车路线和途径点及判断车辆位置偏移</title>
	</head>
	<body>
		<div id="allmap"></div>
	</body>
</html>
<script type="text/javascript" src="../js/jquery-1.8.3.js"></script>
<!-- 判断点在线范围内 -->
<script type="text/javascript" src="../js/GeoUtils.js"></script>
<script type="text/javascript">
	// 百度地图API功能
	var map = new BMap.Map("allmap");
	map.centerAndZoom(new BMap.Point(117.331069,39.00264), 13);
	map.addControl(new BMap.NavigationControl()); // 添加平移缩放控件
	map.addControl(new BMap.ScaleControl()); // 添加比例尺控件
	map.addControl(new BMap.OverviewMapControl()); //添加缩略地图控件
	map.enableScrollWheelZoom(true);
 
	//起点-终点
	var startSpot = new BMap.Point(117.318060,38.998450);
	var endSpot = new BMap.Point(117.318564,39.003005);
 
	//途径点
	var waypointsList = new Array();
	waypointsList.push(new BMap.Point(117.31851,39.000164));
// 	waypointsList.push(new BMap.Point(116.501384, 39.832991));
// 	waypointsList.push(new BMap.Point(116.53353, 39.802379));
 
	// 车辆动态坐标点
	var dynamicZb = new BMap.Point(117.331069,39.00264);
 
	//清除地图上所有的覆盖物
	// 	map.clearOverlays();
	//创建驾车实例
	var driving = new BMap.DrivingRoute(map);
	// 判断有无途径点
	if (waypointsList.length > 0) {
		//第一个驾车搜索(开始路段)
		driving.search(startSpot, waypointsList[0]);
		// 途径点路段
		for (var i = 0; i < waypointsList.length - 1; i++) {
			driving.search(waypointsList[i], waypointsList[i + 1]);
		}
		//第二个驾车搜索(终止路段)
		driving.search(waypointsList[waypointsList.length - 1], endSpot);
	} else {
		driving.search(startSpot, endSpot);
	}
 
	//通过驾车实例，获得一系列点的数组
	var zbList = new Array();
	// 多路段坐标临时变量
	var zbLinshi;
	/**
	 * 路段数统计(与途径点(数组长度+1) 拿到完整坐标点数)
	 * 如：1,2,3,4 起点终点：1/4   途径点：2/3  需绘画3次路段
	 */
	var routeCount = 0;
	driving.setSearchCompleteCallback(function() {
		routeCount++;
		console.log("路段数：" + routeCount);
 
		var pts = driving.getResults().getPlan(0).getRoute(0).getPath();
		//通过驾车实例，获得一系列点的数组       
		var polyline = new BMap.Polyline(pts);
		zbLinshi = polyline.getPath();
 
		console.log("多路段坐标点数：" + zbLinshi.length);
		// 将多个路段坐标点放入集合
		for (var i = 0; i < zbLinshi.length; i++) {
// 			zbList.push("new BMap.Point("+zbLinshi[i].lng);
// 			zbList.push(zbLinshi[i].lat+")");
            zbList.push(zbLinshi[i]);
			// console.log(zbLinshi[i]);
		}
 
 
		map.addOverlay(polyline);
		//创建marker 
		var m1 = new BMap.Marker(startSpot);
		var m2 = new BMap.Marker(endSpot);
		map.addOverlay(m1);
		map.addOverlay(m2);
		if (waypointsList.length > 0) {
			for (var i = 0; i < waypointsList.length; i++) {
				map.addOverlay(new BMap.Marker(waypointsList[i]));
			}
		}
 
		//创建个label    
		var lab1 = new BMap.Label("起点", {
			position: startSpot
		});
		var lab2 = new BMap.Label("终点", {
			position: endSpot
		});
		map.addOverlay(lab1);
		map.addOverlay(lab2);
		if (waypointsList.length > 0) {
			for (var i = 0; i < waypointsList.length; i++) {
				map.addOverlay(new BMap.Label("途径点" + (i + 1), {
					position: waypointsList[i]
				}));
			}
		}
 
		// setTimeout(function() {
		var viewPorts = new Array();
		viewPorts.push(startSpot);
		if (waypointsList.length > 0) {
			for (var i = 0; i < waypointsList.length; i++) {
				viewPorts.push(waypointsList[i]);
			}
		}
		viewPorts.push(endSpot);
		map.setViewport(viewPorts);
 
		//调整到最佳视野        
		// }, 1000);
	});
 
 
 
 
	/*  实时监测返回状态
	BMAP_STATUS_SUCCESS	检索成功。对应数值“0”
	BMAP_STATUS_CITY_LIST	城市列表。对应数值“1”
	BMAP_STATUS_UNKNOWN_LOCATION	位置结果未知。对应数值“2”
	BMAP_STATUS_UNKNOWN_ROUTE	导航结果未知。对应数值“3”
	BMAP_STATUS_INVALID_KEY	非法密钥。对应数值“4”
	BMAP_STATUS_INVALID_REQUEST	非法请求。对应数值“5”
	BMAP_STATUS_PERMISSION_DENIED	没有权限。对应数值“6”
	BMAP_STATUS_SERVICE_UNAVAILABLE	服务不可用。对应数值“7”
	BMAP_STATUS_TIMEOUT	超时。对应数值“8” */
	var checkgetStatus = setInterval(function() {
		if (driving.getStatus() == 0 && waypointsList.length + 1 == routeCount) {
			// 返回成功终止检测
			clearInterval(checkgetStatus);
			console.log("---保存坐标数组----：" + zbList);
			//判断路线偏移
			CheckRouteDeviation(dynamicZb, zbList, 200);
		}
	}, 1000);
 
	/*
	  (判断路线偏移)点是否在线上(通过以每个坐标点为圆心,自定以半径范围；检测某个坐标点是否在圆中)
	  dynamicZb：要判断的坐标；zbList：线路坐标数组；radius：半径范围
    */
	function CheckRouteDeviation(dynamicZb, zbList, radius) {
		var circles = [];
		//遍历坐标集合，以每一个坐标点为圆心，创建圆
		for (var i = 0; i < zbList.length; i++) {
			var c = zbList[i]; //圆心 
			//测试圆 radius代表圆的半径距离 单位：米
			var circle = new BMap.Circle(c, radius);
			circles.push(circle);
			// 绘画圆
			map.addOverlay(circle);
		}
		// console.log("测试圆：" + circles);
 
		//循环遍历判断车辆当前坐标点是否在圆里
		var flag = false;
		for (var i = 0; i < circles.length; i++) {
			//point:当前坐标点、circles[i]:规划好的圆
			var result = BMapLib.GeoUtils.isPointInCircle(dynamicZb, circles[i]);
			if (result == true) { //true：点是在圆圈里
				flag = true;
				break;
			}
		}
		console.log("点是否在线路上(是否在线路坐标点圆中)：" + flag);
	}
 
 
	$(function() {
		// 		 ptInCircle();
	})
 
	// ----------------------------------------- 未用 ----------------------------
	//点在圆内
	function ptInCircle() {
		var pt = new BMap.Point(116.404, 39.915); //测试点
		var c = new BMap.Point(116.404, 39.915); //圆心 
		var circle = new BMap.Circle(c, 5); //测试圆
 
		var result = BMapLib.GeoUtils.isPointInCircle(pt, circle);
		if (result == true) {
			// alert("点在圆形内");
		} else {
			// alert("点在圆形外")
		}
 
		//演示：将点与圆形添加到地图上
		// map.clearOverlays();
		// 		var mkr = new BMap.Marker(pt);
		// 		map.addOverlay(mkr);
		map.addOverlay(circle);
	}
 
	//点在圆外
	function ptOutCircle() {
		var pt = new BMap.Point(116.396, 39.915); //测试点
		var c = new BMap.Point(116.404, 39.915); //圆心 
		var circle = new BMap.Circle(c, 5); //测试圆        
 
		var result = BMapLib.GeoUtils.isPointInCircle(pt, circle);
		if (result == true) {
			alert("点在圆形内");
		} else {
			alert("点在圆形外")
		}
 
		//演示：将点与圆形添加到地图上
		map.clearOverlays();
		var mkr = new BMap.Marker(pt);
		map.addOverlay(mkr);
		map.addOverlay(circle);
	}
</script>